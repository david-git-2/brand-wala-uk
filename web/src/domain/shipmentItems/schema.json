{
  "$id": "shipment_product_agg",
  "collection": "shipment_product_agg",
  "documentId": "{shipment_id}__{product_id}",
  "description": "Operational aggregate per shipment product row. Admin enters arrived/damage buckets once per product; system distributes to per-order allocation rows.",
  "required": [
    "shipment_id",
    "product_id",
    "name",
    "needed_qty_total",
    "arrived_qty_total",
    "damaged_qty_total",
    "expired_qty_total",
    "stolen_qty_total",
    "other_qty_total",
    "available_qty_total",
    "delivered_qty_total",
    "unit_product_weight_g",
    "unit_package_weight_g",
    "unit_total_weight_g",
    "created_at",
    "updated_at"
  ],
  "properties": {
    "shipment_id": { "type": "string" },
    "product_id": { "type": "string" },
    "product_code": { "type": "string" },
    "barcode": { "type": "string" },
    "name": { "type": "string" },
    "image_url": { "type": "string" },

    "needed_qty_total": {
      "type": "number",
      "minimum": 0,
      "x-derived-from": "linked order_items remaining quantities"
    },
    "arrived_qty_total": { "type": "number", "minimum": 0 },
    "damaged_qty_total": { "type": "number", "minimum": 0 },
    "expired_qty_total": { "type": "number", "minimum": 0 },
    "stolen_qty_total": { "type": "number", "minimum": 0 },
    "other_qty_total": { "type": "number", "minimum": 0 },

    "delivered_qty_total": {
      "type": "number",
      "minimum": 0,
      "x-computed": true,
      "x-derived-from": "shipment_allocations.customer_delivered_qty"
    },
    "available_qty_total": {
      "type": "number",
      "minimum": 0,
      "x-computed": true,
      "x-derived-from": "max(0, arrived-damaged-expired-stolen-other-delivered)"
    },

    "unit_product_weight_g": { "type": "integer", "minimum": 0 },
    "unit_package_weight_g": { "type": "integer", "minimum": 0 },
    "unit_total_weight_g": { "type": "integer", "minimum": 0 },

    "planned_weight_g_total": { "type": "number", "minimum": 0 },
    "arrived_weight_g_total": { "type": "number", "minimum": 0 },
    "received_weight_g_total": { "type": "number", "minimum": 0 },

    "purchase_unit_gbp_snapshot": { "type": "number", "minimum": 0 },

    "order_refs": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["order_id", "order_item_id", "planned_qty", "arrived_qty"],
        "properties": {
          "order_id": { "type": "string" },
          "order_item_id": { "type": "string" },
          "planned_qty": { "type": "number", "minimum": 0 },
          "arrived_qty": { "type": "number", "minimum": 0 }
        }
      }
    },

    "created_at": { "type": "timestamp" },
    "updated_at": { "type": "timestamp" }
  }
}
